<%- include("../../views/partials/user/header") %>

    <style>
        .product-badges .hot {
            position: relative;
            display: inline-block;
            background: linear-gradient(to bottom, #ff4500, #ff6347);
            color: white;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 5px;
            text-transform: uppercase;
            text-shadow: 0 0 5px #ff4500, 0 0 10px #ff6347;
            animation: flicker 1.2s infinite;
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.8), 0 0 20px rgba(255, 140, 0, 0.5);
        }

        .product-badges .hot::before, 
        .product-badges .hot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 165, 0, 0.8) 10%, rgba(255, 69, 0, 0) 80%);
            z-index: -1;
            animation: flame-move 2s infinite alternate ease-in-out;
            opacity: 0.7;
            mix-blend-mode: screen;
        }

        .product-badges .hot::after {
            animation-duration: 1.5s;
            animation-delay: 0.3s;
        }

        @keyframes flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes flame-move {
            0% {
                transform: translate(-50%, -60%) scale(1);
                opacity: 0.8;
            }
            25% {
                transform: translate(-52%, -62%) scale(1.1);
            }
            50% {
                transform: translate(-48%, -55%) scale(1.05);
            }
            75% {
                transform: translate(-50%, -58%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -60%) scale(1);
                opacity: 0.5;
            }
        }
        /* Mobile Search Styling */
        .mobile-search {
            margin-top: 40px;
            max-width: 100%;
            margin-bottom: 15px;
            position: relative;
        }

        #searchForm {
            width: 50%;
            /* Reduced size */
            margin: 0 auto;
            /* Centers the form */
        }

        #searchInput {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            outline: none;
        }

        #searchInput:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        /* Position the search icon inside the input field */
        .fi-rs-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 18px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #searchForm {
                width: 70%;
                /* Slightly larger on smaller screens */
            }

            #searchInput {
                font-size: 16px;
                padding: 10px 30px 10px 10px;
            }

            .fi-rs-search {
                font-size: 16px;
            }
        }
        
    </style>

    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="/"><img src="/evara-user/assets/imgs/theme/logo.svg" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for items…">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">

                    <!-- mobile menu start -->
                    <nav>
                        <ul class="mobile-menu">
                            <li class="menu-item-has-children"><a href="/">Home</a>

                            </li>
                            <li class="menu-item-has-children"><a href="shop-grid-right.html">shop</a>

                            </li>

                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>

                <div class="mobile-social-icon">
                    <h5 class="mb-15 text-grey-4">Follow Us</h5>
                    <a href="#"><img src="/evara-user/assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                    <a href="#"><img src="/evara-user/assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                    <a href="#"><img src="/evara-user/assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                    <a href="#"><img src="/evara-user/assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                    <a href="#"><img src="/evara-user/assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Shop
                </div>
            </div>
        </div>
        <div class="mobile-search search-style-3 mobile-header-border">
            <form id="searchForm" action="#" style="width: 50%; margin: 0 auto; position: relative;">
                <input type="text" id="searchInput" placeholder="Search for items…" onkeyup="liveSearch()"
                    style="width: 100%; padding: 10px 40px 10px 15px; border: 1px solid #ddd; border-radius: 30px; font-size: 14px; transition: all 0.3s ease; box-sizing: border-box;">
                <button type="submit" style="display:none;"></button>
                <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888;">
                    <i class="fi-rs-search" style="font-size: 18px;"></i>
                </span>
            </form>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="shop-product-fillter">
                            <div class="totall-product">
                                <p> We found <strong class="text-brand">
                                        <%=products.length%>
                                    </strong> items for you!</p>
                            </div>
                            <div class="sort-by-product-area">
                                <div class="sort-by-cover">
                                    <a href="#" onclick="resetFilters(event)" class="sort-by-product-wrap" style="text-decoration: none; color: inherit;">
                                        <div class="sort-by">
                                            <span><i class="fi-rs-rotate-right"></i>Reset All Filters</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <div class="sort-by-product-area">
                                <div class="sort-by-cover">
                                    <div class="sort-by-product-wrap">
                                        <div class="sort-by">
                                            <span><i class="fi-rs-apps-sort"></i>Sort by:</span>
                                        </div>
                                        <div class="sort-by-dropdown-wrap">
                                            <span> Category <i class="fi-rs-angle-small-down"></i></span>
                                        </div>
                                    </div>
                                    <div class="sort-by-dropdown">
                                        <ul>
                                            <% categories.forEach(category => { %>
                                                <li>
                                                    <a href="#" class="category-link" data-category-id="<%= category._id %>">
                                                        <%= category.name %>
                                                    </a>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="sort-by-product-area">
                                
                                <div class="sort-by-cover">
                                    <div class="sort-by-product-wrap">
                                        <div class="sort-by">
                                            <span><i class="fi-rs-apps-sort"></i>Filter by:</span>
                                        </div>
                                        <div class="sort-by-dropdown-wrap">
                                            <span> Filter <i class="fi-rs-angle-small-down"></i></span>
                                        </div>
                                    </div>
                                    <div class="sort-by-dropdown">
                                        <ul>
                                            <li><a href="/products?sortBy=mostPopular">Most Popular</a></li>
                                            <li><a href="/products?sortBy=priceLowHigh">Price: Low to High</a></li>
                                            <li><a href="/products?sortBy=priceHighLow">Price: High to Low</a></li>
                                            <li><a href="/products?sortBy=newArrivals">New Arrivals</a></li>
                                            <li><a href="/products?sortBy=avgRating">Avg. Rating</a></li>
                                            <li><a href="/products?sortBy=aToZ">aA - zZ</a></li>
                                            <li><a href="/products?sortBy=zToA">zZ - aA</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="product-list" class="row product-grid-4">
                            <% if (products && products.length > 0) { %>
                                <div class="row product-grid">
                                    <% products.filter(product => product.quantity > 0).forEach(product => { %>
                                        <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                                            <div class="product-cart-wrap mb-30">
                                                <!-- Product Image Section -->
                                                <div class="product-img-action-wrap">
                                                    <div class="product-img product-img-zoom">
                                                        <a href="/productDetails?id=<%= product._id %>">
                                                            <% if (product.productImage && product.productImage.length > 0) { %>
                                                                <img class="default-img" 
                                                                     src="/uploads/re-image/<%= product.productImage[0] %>" 
                                                                     alt="<%= product.productName %>"
                                                                     onerror="this.src='/assets/imgs/placeholder.jpg'">
                                                            <% } else { %>
                                                                <img class="default-img" 
                                                                     src="/assets/imgs/placeholder.jpg" 
                                                                     alt="Product image not available">
                                                            <% } %>
                                                        </a>
                                                    </div>
                            
                                                    <!-- Wishlist Button -->
                                                    <div class="product-action-1">
                                                        <a aria-label="Add To Wishlist"
                                                           class="action-btn hover-up add-to-wishlist"
                                                           data-product-id="<%= product._id %>">
                                                            <i class="fi-rs-heart"></i>
                                                        </a>
                                                    </div>
                            
                                                    <!-- Category Badge -->
                                                    <% if (category && product.category) { %>
                                                        <% const matchingCategory = category.find(cat => 
                                                            cat._id && product.category && 
                                                            cat._id.toString() === (product.category._id || product.category).toString()
                                                        ); %>
                                                        <% if (matchingCategory && matchingCategory.name === 'Flagship') { %>
                                                            <div class="product-badges product-badges-position product-badges-mrg">
                                                                <span class="hot">Hot</span>
                                                            </div>
                                                        <% } %>
                                                    <% } %>
                                                </div>
                            
                                                <!-- Product Content Section -->
                                                <div class="product-content-wrap">
                                                    <!-- Brand -->
                                                    <div class="product-category">
                                                        <a href="/shop?brand=<%= encodeURIComponent(product.brand) %>">
                                                            <%= product.brand %>
                                                        </a>
                                                    </div>
                            
                                                    <!-- Product Name -->
                                                    <h2 class="product-title">
                                                        <a href="/productDetails?id=<%= product._id %>">
                                                            <%= product.productName %>
                                                        </a>
                                                    </h2>
                            
                                                    <!-- Product Details Based on Stock -->
                                                     
                                                    <% if (product.quantity > 0) { %>
                                                        <!-- Rating -->
                                                        
                                                            <div class="rating-result" title="90%">
                                                                <span><span>90%</span></span>
                                                            </div>
                                                        
                            
                                                        <!-- Price -->
                                                        <div class="product-price">
                                                            <span class="current-price">₹<%= product.salePrice.toLocaleString() %></span>
                                                            <% if (product.regularPrice > product.salePrice) { %>
                                                                <span class="old-price">₹<%= product.regularPrice.toLocaleString() %></span>
                                                                <% if(product.category.categoryOffer || product.productOffer){ %>
                                                                    <span class="offer-badge">
                                                                        <span class="offer-text" style="font-size: 0.80rem;"><%= product.category.categoryOffer || product.productOffer %>% OFF</span>
                                                                    </span>
                                                                <% } %>
                                                            <% } %>
                                                        </div>

                                                        <!-- Add to Cart Button -->
                                                        <div class="product-action-1 show">
                                                            <button onclick="addToCart('<%= product._id %>')" 
                                                                    aria-label="Add To Cart" 
                                                                    class="action-btn hover-up">
                                                                <i class="fi-rs-shopping-bag-add"></i>
                                                            </button>
                                                        </div>
                                                    
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            <% } else { %>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="text-center p-4">
                                            <h4>No products found matching the filters.</h4>
                                            <p>Try adjusting your search criteria or browse our other categories.</p>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>

                        <div class="pagination-area mt-15 mb-50">
                            <nav aria-label="Page navigation example">
                                <ul class="pagination justify-content-center">
                                    <% for (let i = 1; i <=totalPages; i++) { %>
                                        <li class="page-item <%= (i === currentPage) ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>">
                                                <%= i %>
                                            </a>
                                        </li>
                                        <% } %>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>



    <script>

        function resetFilters(e) {
            e.preventDefault();
            window.location.href = '/shop';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const categoryLinks = document.querySelectorAll(".category-link");

            categoryLinks.forEach(link => {
                link.addEventListener("click", function (event) {
                    event.preventDefault(); // Prevent default link behavior

                    categoryLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    const categoryId = this.getAttribute('data-category-id')
                    fetchFilteredProducts(categoryId);
                });
            });
        });

        function fetchFilteredProducts(categoryId) {
            $.ajax({
                url: `/shop?category=${categoryId}`,
                method: 'GET',
                beforeSend: function() {
                    // Optional: Show loading spinner
                    $('#product-list').html('<div class="text-center"><i class="fi-rs-spinner fa-spin"></i> Loading...</div>');
                },
                success: function (response) {
                    
                    $('#product-list').html(response);

                    attachWishlistListeners();
                    
                },
                error: function (error) {
                    console.error('Error fetching filtered products:', error);
                    $('#product-list').html(`
                        <div class="text-center p-4">
                            <h4>Error loading products</h4>
                            <p>Please try again later.</p>
                        </div>
                    `);
                }
            });
        }


        let debounceTimer;

        function liveSearch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = document.getElementById('searchInput').value.trim();

                if (!query) {
                    fetchAllProducts();
                    return;
                }

                fetch(`/search?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const productsContainer = document.querySelector('.row.product-grid-4');
                        productsContainer.innerHTML = '';

                        data.products.forEach(product => {
                            // Only show products that are in stock
                            if (product.quantity > 0) {
                                const productHTML = `
                                    <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                                        <div class="product-cart-wrap mb-30">
                                            <!-- Product Image Section -->
                                            <div class="product-img-action-wrap">
                                                <div class="product-img product-img-zoom">
                                                    <a href="/productDetails?id=${product._id}">
                                                        ${product.productImage && product.productImage.length > 0 
                                                            ? `<img class="default-img" src="/uploads/re-image/${product.productImage[0]}" 
                                                                alt="${product.productName}" 
                                                                onerror="this.src='/assets/imgs/placeholder.jpg'">`
                                                            : `<img class="default-img" src="/assets/imgs/placeholder.jpg" 
                                                                alt="Product image not available">`}
                                                    </a>
                                                </div>
                                                
                                                <!-- Wishlist Button -->
                                                <div class="product-action-1">
                                                    <a aria-label="Add To Wishlist" 
                                                    class="action-btn hover-up add-to-wishlist" 
                                                    data-product-id="${product._id}">
                                                        <i class="fi-rs-heart"></i>
                                                    </a>
                                                </div>

                                                <!-- Category Badge -->
                                                ${product.category && product.category.name === 'Flagship' 
                                                    ? `<div class="product-badges product-badges-position product-badges-mrg">
                                                        <span class="hot">Hot</span>
                                                    </div>`
                                                    : ''}
                                            </div>

                                            <!-- Product Content Section -->
                                            <div class="product-content-wrap">
                                                <!-- Brand -->
                                                <div class="product-category">
                                                    <a href="/shop?brand=${encodeURIComponent(product.brand)}">
                                                        ${product.brand}
                                                    </a>
                                                </div>

                                                <!-- Product Name -->
                                                <h2 class="product-title">
                                                    <a href="/productDetails?id=${product._id}">
                                                        ${product.productName}
                                                    </a>
                                                </h2>

                                                <!-- Rating -->
                                                <div class="rating-result" title="90%">
                                                    <span><span>90%</span></span>
                                                </div>

                                                <!-- Price -->
                                                <div class="product-price">
                                                    <span class="current-price">₹${product.salePrice.toLocaleString()}</span>
                                                    ${product.regularPrice > product.salePrice 
                                                        ? `<span class="old-price">₹${product.regularPrice.toLocaleString()}</span>
                                                        ${(product.category?.categoryOffer || product.productOffer) 
                                                            ? `<span class="offer-badge">
                                                                    <span class="offer-text" style="font-size: 0.80rem;">
                                                                        ${product.category?.categoryOffer || product.productOffer}% OFF
                                                                    </span>
                                                                </span>`
                                                            : ''}`
                                                        : ''}
                                                </div>

                                                <!-- Add to Cart Button -->
                                                <div class="product-action-1 show">
                                                    <button onclick="addToCart('${product._id}')" 
                                                            aria-label="Add To Cart" 
                                                            class="action-btn hover-up">
                                                        <i class="fi-rs-shopping-bag-add"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                productsContainer.innerHTML += productHTML;
                            }
                        });

                        // Reattach event listeners for wishlist buttons
                        attachWishlistListeners();
                    })
                    .catch(error => {
                        console.error('Error fetching search results:', error);
                    });
            }, 300);
        }

        function fetchAllProducts() {
            fetch('/all-products')
                .then(response => response.json())
                .then(data => {
                    const productsContainer = document.querySelector('.row.product-grid-4');
                    productsContainer.innerHTML = '';

                    data.products.forEach(product => {
                        if (product.quantity > 0) {
                            const productHTML = `
                                <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                                    <div class="product-cart-wrap mb-30">
                                        <!-- Product Image Section -->
                                        <div class="product-img-action-wrap">
                                            <div class="product-img product-img-zoom">
                                                <a href="/productDetails?id=${product._id}">
                                                    ${product.productImage && product.productImage.length > 0 
                                                        ? `<img class="default-img" src="/uploads/re-image/${product.productImage[0]}" 
                                                            alt="${product.productName}" 
                                                            onerror="this.src='/assets/imgs/placeholder.jpg'">`
                                                        : `<img class="default-img" src="/assets/imgs/placeholder.jpg" 
                                                            alt="Product image not available">`}
                                                </a>
                                            </div>
                                            
                                            <!-- Wishlist Button -->
                                            <div class="product-action-1">
                                                <a aria-label="Add To Wishlist" 
                                                class="action-btn hover-up add-to-wishlist" 
                                                data-product-id="${product._id}">
                                                    <i class="fi-rs-heart"></i>
                                                </a>
                                            </div>

                                            <!-- Category Badge -->
                                            ${product.category && product.category.name === 'Flagship' 
                                                ? `<div class="product-badges product-badges-position product-badges-mrg">
                                                    <span class="hot">Hot</span>
                                                </div>`
                                                : ''}
                                        </div>

                                        <!-- Product Content Section -->
                                        <div class="product-content-wrap">
                                            <!-- Brand -->
                                            <div class="product-category">
                                                <a href="/shop?brand=${encodeURIComponent(product.brand)}">
                                                    ${product.brand}
                                                </a>
                                            </div>

                                            <!-- Product Name -->
                                            <h2 class="product-title">
                                                <a href="/productDetails?id=${product._id}">
                                                    ${product.productName}
                                                </a>
                                            </h2>

                                            <!-- Rating -->
                                            <div class="rating-result" title="90%">
                                                <span><span>90%</span></span>
                                            </div>

                                            <!-- Price -->
                                            <div class="product-price">
                                                <span class="current-price">₹${product.salePrice.toLocaleString()}</span>
                                                ${product.regularPrice > product.salePrice 
                                                    ? `<span class="old-price">₹${product.regularPrice.toLocaleString()}</span>
                                                    ${(product.category?.categoryOffer || product.productOffer) 
                                                        ? `<span class="offer-badge">
                                                                <span class="offer-text" style="font-size: 0.80rem;">
                                                                    ${product.category?.categoryOffer || product.productOffer}% OFF
                                                                </span>
                                                            </span>`
                                                        : ''}`
                                                    : ''}
                                            </div>

                                            <!-- Add to Cart Button -->
                                            <div class="product-action-1 show">
                                                <button onclick="addToCart('${product._id}')" 
                                                        aria-label="Add To Cart" 
                                                        class="action-btn hover-up">
                                                    <i class="fi-rs-shopping-bag-add"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            productsContainer.innerHTML += productHTML;
                        }
                    });

                    // Reattach event listeners for wishlist buttons
                    attachWishlistListeners();
                })
                .catch(error => {
                    console.error('Error fetching all products:', error);
                });
        }



        function addToCart(productId, quantity = 1) {
            fetch(`/addToCart?productId=${productId}&quantity=${quantity}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 200) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: data.message,
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else if (data.status === 400) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Oops!',
                            text: data.message,
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }else{
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: data.message || 'Something went wrong!',
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                });
        }

        document.querySelectorAll('.add-to-wishlist').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();

                const productId = button.getAttribute('data-product-id');

                try {
                    const response = await fetch('/addToWishList', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ product_id: productId })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        Swal.fire('Success', data.message, 'success');
                    } else {
                        Swal.fire('Error', data.error || 'Failed to add to wishlist', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', 'Something went wrong', 'error');
                    console.error('Error adding to wishlist:', error);
                }
            });
        });



        function attachWishlistListeners(){
            document.querySelectorAll('.add-to-wishlist').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();

                    const productId = button.getAttribute('data-product-id');

                    try {
                        const response = await fetch('/addToWishList', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ product_id: productId })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            Swal.fire('Success', data.message, 'success');
                        } else {
                            Swal.fire('Error', data.error || 'Failed to add to wishlist', 'error');
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Something went wrong', 'error');
                        console.error('Error adding to wishlist:', error);
                    }
                });
            });
        }
    </script>



    <%- include("../../views/partials/user/footer") %>